<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flag - ä½ çš„ç›®æ ‡è¾¾æˆåŠ©æ‰‹</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root { --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: #F8F9FB; color: #1D1D1F; overflow: hidden; }
        .flag-gradient { background: linear-gradient(135deg, #FF3B30 0%, #FF2D55 100%); }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); }
        .card-shadow { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03); }
        .modal-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .login-bg { background-image: radial-gradient(circle at 20% 30%, #fff0f0 0%, #f8f9fb 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase åˆå§‹åŒ– ---
        let db = null;
        let auth = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'flag-final-demo-v1';

        const initFirebase = () => {
            if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                try {
                    const config = JSON.parse(__firebase_config);
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    return true;
                } catch (e) { console.error(e); }
            }
            return false;
        };

        // --- ä¸»ç¨‹åºå®¹å™¨ ---
        function App() {
            const [user, setUser] = useState(null);
            const [authLoaded, setAuthLoaded] = useState(false);
            const [demoMode, setDemoMode] = useState(false); // å¼ºåˆ¶ Demo ç™»å½•çŠ¶æ€

            useEffect(() => {
                const ready = initFirebase();
                if (ready) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        setAuthLoaded(true);
                    });
                    return () => unsubscribe();
                } else {
                    setAuthLoaded(true);
                }
            }, []);

            // ç™»å‡ºå‡½æ•°
            const handleSignOut = () => {
                if (auth) auth.signOut();
                setDemoMode(false);
                setUser(null);
            };

            if (!authLoaded) return (
                <div className="h-screen w-screen flex items-center justify-center bg-white text-red-500">
                    <div className="w-8 h-8 border-4 border-current border-t-transparent rounded-full animate-spin"></div>
                </div>
            );

            // åªè¦ Firebase æœ‰ç”¨æˆ·ï¼Œæˆ–è€…å¤„äº Demo æˆåŠŸæ¨¡å¼ï¼Œå°±è¿›å…¥ä¸»é¡µ
            if (user || demoMode) {
                return <MainApp user={user || { uid: 'demo-user-id' }} onSignOut={handleSignOut} />;
            }

            return <LoginScreen onLoginSuccess={() => setDemoMode(true)} />;
        }

        // --- æ¼”ç¤ºç‰ˆç™»å½•ç»„ä»¶ ---
        function LoginScreen({ onLoginSuccess }) {
            const [mode, setMode] = useState('login'); 
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isBusy, setIsBusy] = useState(false);

            const performMockLogin = async () => {
                setIsBusy(true);
                // 1. æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿï¼š2ç§’
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 2. å°è¯•åå°é™é»˜ç™»å½•ï¼ˆä¸ºäº†ç»´æŒæ•°æ®åº“è¿æ¥ï¼‰
                try {
                    if (auth) {
                        await auth.signInAnonymously();
                    }
                } catch (e) {
                    console.warn("Firebase Auth Error (Safe to ignore in demo):", e);
                }
                
                // 3. æ ¸å¿ƒï¼šå¼ºåˆ¶è§¦å‘å¸ƒå±€åˆ‡æ¢åˆ°ä¸»é¡µ
                onLoginSuccess();
                setIsBusy(false);
            };

            const handleAuth = (e) => {
                e.preventDefault();
                performMockLogin();
            };

            const handleSocialLogin = () => {
                performMockLogin();
            };

            return (
                <div className="h-screen w-screen login-bg flex flex-col px-8 justify-center items-center overflow-y-auto">
                    <div className="w-20 h-20 flag-gradient rounded-[2.2rem] shadow-2xl flex items-center justify-center text-white text-4xl font-black mb-8 italic transform -rotate-3">F</div>
                    
                    <div className="w-full max-w-sm bg-white rounded-[2.5rem] p-8 card-shadow border border-white/50">
                        <div className="text-center mb-8">
                            <h2 className="text-2xl font-black text-slate-900">{mode === 'login' ? 'æ¬¢è¿å›æ¥' : 'å¼€å¯æŒ‘æˆ˜'}</h2>
                            <p className="text-slate-400 text-xs mt-1 font-bold uppercase tracking-widest">ç«‹ä¸ª Flagï¼Œä¸‡ä¸€å®ç°äº†å‘¢</p>
                        </div>

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <input 
                                    type="email" 
                                    placeholder="é‚®ç®±/æ‰‹æœºå·" 
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full bg-slate-50 border-none rounded-2xl py-4 px-6 focus:ring-2 focus:ring-red-500/20 outline-none font-bold text-slate-700 placeholder:text-slate-300"
                                />
                            </div>
                            <div>
                                <input 
                                    type="password" 
                                    placeholder="å¯†ç " 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full bg-slate-50 border-none rounded-2xl py-4 px-6 focus:ring-2 focus:ring-red-500/20 outline-none font-bold text-slate-700 placeholder:text-slate-300"
                                />
                            </div>
                            <button 
                                type="submit"
                                disabled={isBusy}
                                className="w-full py-4 flag-gradient text-white rounded-2xl font-black shadow-lg shadow-red-100 active:scale-95 transition-all flex justify-center items-center h-[56px]"
                            >
                                {isBusy ? <div className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin"></div> : (mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œå¹¶å¼€å§‹')}
                            </button>
                        </form>

                        <div className="flex items-center my-8">
                            <div className="flex-grow h-[1px] bg-slate-100"></div>
                            <span className="px-4 text-[10px] text-slate-300 font-bold uppercase tracking-widest">æˆ–è€…</span>
                            <div className="flex-grow h-[1px] bg-slate-100"></div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={handleSocialLogin} disabled={isBusy} className="flex items-center justify-center py-3 bg-slate-50 rounded-2xl text-slate-600 font-bold text-xs gap-2 active:scale-95 transition-all disabled:opacity-50">
                                <svg width="18" height="18" fill="#07C160" viewBox="0 0 24 24"><path d="M8.5 12c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm7 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zM22 10.5c0-4.14-3.81-7.5-8.5-7.5S5 6.36 5 10.5c0 2.15 1.03 4.11 2.71 5.49L7 19l3.35-1.68c.51.13 1.03.2 1.65.2 4.69 0 8.5-3.36 8.5-7.52zm-12.25 8.7L7.5 20.5l.5-2.5c-2.4-1.7-4-4.2-4-7C4 6.4 8.5 3 14 3s10 3.4 10 8-4.5 8-10 8c-.7 0-1.4-.05-2.05-.15z"/></svg>
                                å¾®ä¿¡
                            </button>
                            <button onClick={handleSocialLogin} disabled={isBusy} className="flex items-center justify-center py-3 bg-slate-50 rounded-2xl text-slate-600 font-bold text-xs gap-2 active:scale-95 transition-all disabled:opacity-50">
                                <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#EA4335" d="M5.266 9.765A7.077 7.077 0 0 1 12 4.909c1.69 0 3.218.6 4.418 1.582L19.91 3C17.782 1.145 15.055 0 12 0 7.27 0 3.198 2.698 1.24 6.65l4.026 3.115z"/><path fill="#34A853" d="M16.04 18.013c-1.09.513-2.332.809-3.64.809-3.132 0-5.786-2.095-6.734-4.945l-4.04 3.125C3.582 20.94 7.518 24 12 24c3.086 0 5.86-1.114 7.96-2.968l-3.92-3.019z"/><path fill="#4285F4" d="M23.49 12.275c0-.825-.075-1.62-.215-2.385H12v4.515h6.44c-.28 1.505-1.125 2.78-2.4 3.635l3.92 3.02C22.25 19.115 24 15.935 24 12.275z"/><path fill="#FBBC05" d="M5.266 14.235l-4.026 3.115A11.932 11.932 0 0 1 0 12c0-1.92.445-3.73 1.24-5.35l4.026 3.115c-.215.655-.33 1.355-.33 2.085 0 .73.115 1.43.33 2.085z"/></svg>
                                Google
                            </button>
                        </div>
                    </div>

                    <button 
                        onClick={() => setMode(mode === 'login' ? 'register' : 'login')}
                        className="mt-8 text-xs font-black text-slate-400 uppercase tracking-[0.2em]"
                    >
                        {mode === 'login' ? 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ' : 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•'}
                    </button>
                </div>
            );
        }

        // --- ä¸»åº”ç”¨é€»è¾‘ ---
        function MainApp({ user, onSignOut }) {
            const [view, setView] = useState('home'); 
            const [isCreating, setIsCreating] = useState(false);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [myFlags, setMyFlags] = useState([]);
            const [publicFlags, setPublicFlags] = useState([]);

            const userName = useMemo(() => `Flag_User_${user.uid.slice(-4)}`, [user]);

            useEffect(() => {
                if (!db || !user.uid) return;
                const unsub1 = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags')
                    .onSnapshot(s => setMyFlags(s.docs.map(d => ({ id: d.id, ...d.data() }))), e => console.log(e));
                
                const unsub2 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags')
                    .onSnapshot(s => setPublicFlags(s.docs.map(d => ({ id: d.id, ...d.data() }))), e => console.log(e));
                
                return () => { unsub1(); unsub2(); };
            }, [user]);

            const handleAISplit = async () => {
                if (!inputText.trim()) return;
                setIsLoading(true);
                const apiKey = ""; 
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§ç›®æ ‡è¾¾æˆæ•™ç»ƒã€‚è¯·å°†ç”¨æˆ·ç›®æ ‡æ‹†è§£ä¸º3ä¸ªæç®€é˜¶æ®µã€‚JSONæ ¼å¼: {"milestones": [{"title": "é˜¶æ®µ1", "tip": "å…·ä½“å»ºè®®"}]}`;
                let milestones = [{ title: "å¯åŠ¨å‡†å¤‡", tip: "æ”¶é›†å¿…è¦èµ„æº" }, { title: "æ ¸å¿ƒæ”»åš", tip: "ä¸“æ³¨å…³é”®ç¯èŠ‚" }, { title: "æˆæœå·©å›º", tip: "è´¨é‡æ£€æŸ¥" }];
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `ç›®æ ‡ï¼š${inputText}` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const aiData = JSON.parse(result.candidates[0].content.parts[0].text);
                        milestones = aiData.milestones;
                    }
                } catch (err) {}

                const newFlag = {
                    title: inputText,
                    progress: 0,
                    steps: milestones.map(m => ({ title: m.title, tip: m.tip || "åŠ æ²¹ï¼", done: false })),
                    uid: user.uid,
                    userName: userName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (db) {
                        const ref = await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').add(newFlag);
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(ref.id).set(newFlag);
                    } else {
                        // å¦‚æœæ²¡æœ‰DBï¼Œæœ¬åœ°æ¨¡æ‹Ÿå¢åŠ 
                        setMyFlags([{ id: Date.now(), ...newFlag }, ...myFlags]);
                    }
                    setIsCreating(false);
                    setInputText('');
                } catch (e) {}
                setIsLoading(false);
            };

            const toggleStep = async (flagId, idx) => {
                const flag = myFlags.find(f => f.id === flagId);
                if (!flag) return;
                const newSteps = flag.steps.map((s, i) => i === idx ? { ...s, done: !s.done } : s);
                const progress = Math.round((newSteps.filter(s => s.done).length / newSteps.length) * 100);
                if (newSteps[idx].done) confetti({ particleCount: 30, spread: 60, origin: { y: 0.8 } });
                
                if (db) {
                    const batch = db.batch();
                    batch.update(db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').doc(flagId), { steps: newSteps, progress });
                    batch.update(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(flagId), { steps: newSteps, progress });
                    await batch.commit();
                } else {
                    setMyFlags(myFlags.map(f => f.id === flagId ? { ...f, steps: newSteps, progress } : f));
                }
            };

            return (
                <div className="h-screen w-screen flex flex-col bg-[#F8F9FB] overflow-hidden">
                    <header className="shrink-0 glass-header px-6 pb-4 pt-[var(--safe-top)] border-b border-slate-100 z-20 flex justify-between items-end h-24">
                        <h1 className="text-2xl font-black tracking-tighter">{view === 'home' ? 'MY FLAGS' : 'å¹¿åœº'}</h1>
                        <button onClick={onSignOut} className="text-[10px] font-bold text-slate-300 uppercase tracking-widest border border-slate-100 px-3 py-1 rounded-full">Sign Out</button>
                    </header>
                    <main className="flex-grow overflow-y-auto no-scrollbar px-6 py-6 pb-32">
                        {view === 'home' ? (
                            <div className="space-y-6">
                                {myFlags.length === 0 && (
                                    <div className="text-center py-20 opacity-30 select-none">
                                        <div className="text-6xl mb-4">â›³ï¸</div>
                                        <p className="font-bold text-slate-400 uppercase tracking-[0.2em] text-xs">ç«‹ä¸ª Flagï¼Œä¸‡ä¸€å®ç°äº†å‘¢</p>
                                    </div>
                                )}
                                {myFlags.map(flag => (
                                    <div key={flag.id} className="bg-white rounded-[2.5rem] p-7 card-shadow border border-slate-50">
                                        <h2 className="text-xl font-black mb-6 text-slate-800">{flag.title}</h2>
                                        <div className="space-y-4 mb-8">
                                            {flag.steps.map((step, i) => (
                                                <div key={i} onClick={() => toggleStep(flag.id, i)} className="flex gap-4 items-start cursor-pointer">
                                                    <div className={`shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all mt-0.5 ${step.done ? 'bg-red-500 border-red-500 shadow-lg' : 'border-slate-100 bg-slate-50'}`}>
                                                        {step.done && <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4"><path d="M20 6L9 17l-5-5"></path></svg>}
                                                    </div>
                                                    <div className="flex-grow">
                                                        <p className={`font-bold text-sm ${step.done ? 'text-slate-300 line-through' : 'text-slate-700'}`}>{step.title}</p>
                                                        {step.tip && !step.done && <p className="text-[11px] text-slate-400 mt-1 font-medium italic opacity-70 leading-relaxed">ğŸ’¡ {step.tip}</p>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="flex-grow h-2 bg-slate-50 rounded-full overflow-hidden">
                                                <div className="h-full flag-gradient transition-all duration-700" style={{width: `${flag.progress}%`}}></div>
                                            </div>
                                            <span className="text-xs font-black text-slate-400">{flag.progress}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {publicFlags.map(p => (
                                    <div key={p.id} className="bg-white p-6 rounded-3xl card-shadow flex items-center justify-between border border-slate-50">
                                        <div className="flex-grow pr-4">
                                            <p className="font-black text-slate-800 text-lg mb-2">{p.title}</p>
                                            <div className="flex items-center gap-2">
                                                <div className="w-5 h-5 rounded-lg flag-gradient text-[8px] flex items-center justify-center text-white font-black">U</div>
                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{p.userName}</p>
                                            </div>
                                        </div>
                                        <div className="text-right shrink-0">
                                            <p className="text-2xl font-black text-red-500 italic">{p.progress}%</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                    <nav className="shrink-0 glass-header border-t border-slate-100 px-12 pb-[calc(var(--safe-bottom)+1rem)] pt-4 flex justify-between items-center z-30">
                        <button onClick={() => setView('home')} className={view === 'home' ? 'text-red-500' : 'text-slate-300'}><Home size={24} /></button>
                        <button onClick={() => setIsCreating(true)} className="w-14 h-14 -mt-12 flag-gradient rounded-2xl shadow-xl shadow-red-200 flex items-center justify-center text-white text-3xl font-light border-4 border-white transform rotate-45"><span className="-rotate-45">+</span></button>
                        <button onClick={() => setView('discover')} className={view === 'discover' ? 'text-red-500' : 'text-gray-300'}><Compass size={24} /></button>
                    </nav>
                    {isCreating && (
                        <div className="fixed inset-0 z-50 flex items-end">
                            <div className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onClick={() => !isLoading && setIsCreating(false)}></div>
                            <div className="relative w-full bg-white rounded-t-[3rem] p-9 pb-[calc(var(--safe-bottom)+2rem)] modal-enter shadow-2xl">
                                <div className="w-12 h-1.5 bg-slate-100 rounded-full mx-auto mb-8"></div>
                                <h3 className="text-2xl font-black mb-1">æ–°çš„æŒ‘æˆ˜</h3>
                                <p className="text-slate-400 text-xs mb-6 font-bold uppercase tracking-widest">ç«‹ä¸ª Flagï¼Œä¸‡ä¸€å®ç°äº†å‘¢</p>
                                <textarea autoFocus value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªæœˆåå»å¤§ç†æ—…å±…" className="w-full text-lg font-bold border-none focus:ring-0 placeholder:text-slate-200 resize-none mb-8 h-32 bg-slate-50 rounded-3xl p-6"/>
                                <button onClick={handleAISplit} disabled={isLoading || !inputText} className="w-full py-5 rounded-2xl bg-black text-white font-black uppercase disabled:bg-slate-100 transition-all flex justify-center items-center gap-3">
                                    {isLoading ? "è§„åˆ’ä¸­..." : "å¼€å§‹è§„åˆ’"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const Home = ({size}) => <svg width={size} height={size} fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>;
        const Compass = ({size}) => <svg width={size} height={size} fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path></svg>;

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
