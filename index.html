<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flag - ‰Ω†ÁöÑÁõÆÊ†áËææÊàêÂä©Êâã</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root { --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: #F8F9FB; color: #1D1D1F; overflow: hidden; }
        .flag-gradient { background: linear-gradient(135deg, #FF3B30 0%, #FF2D55 100%); }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); }
        .card-shadow { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03); }
        .modal-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase ÂàùÂßãÂåñ ---
        let db = null;
        let auth = null;
        let firebaseReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'flag-pro-v2';

        const initFirebase = () => {
            if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                try {
                    const config = JSON.parse(__firebase_config);
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    firebaseReady = true;
                    return true;
                } catch (e) { console.error(e); }
            }
            return false;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); 
            const [isCreating, setIsCreating] = useState(false);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [myFlags, setMyFlags] = useState([]);
            const [publicFlags, setPublicFlags] = useState([]);

            useEffect(() => {
                const setup = async () => {
                    const ready = initFirebase();
                    if (ready) {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (err) { console.error(err); }
                    } else {
                        setUser({ uid: 'guest_user' });
                    }
                };
                setup();
                if (auth) auth.onAuthStateChanged(setUser);
            }, []);

            useEffect(() => {
                if (!user || !firebaseReady) return;
                const unsub1 = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags')
                    .onSnapshot(s => setMyFlags(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsub2 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags')
                    .onSnapshot(s => setPublicFlags(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsub1(); unsub2(); };
            }, [user]);

            const handleAISplit = async () => {
                if (!inputText.trim()) return;
                setIsLoading(true);
                
                const apiKey = ""; // ËøêË°åÊó∂ÁéØÂ¢ÉÊèê‰æõ
                // --- ‰ºòÂåñÁöÑÊèêÁ§∫ËØçÔºöË¶ÅÊ±ÇÊõ¥Â§öÂÖÉÁöÑ‰ø°ÊÅØ ---
                const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™È°∂Á∫ßÁõÆÊ†áËææÊàêÊïôÁªÉ„ÄÇ
                ËØ∑Â∞ÜÁî®Êà∑ÁõÆÊ†áÊãÜËß£‰∏∫3‰∏™ÊûÅÁÆÄÈò∂ÊÆµ„ÄÇ
                ÊØè‰∏™Èò∂ÊÆµÈúÄË¶ÅÔºö1.Ê†áÈ¢ò(5Â≠óÂÜÖ) 2.ÊïôÁªÉË¥¥Â£´(Ê†∏ÂøÉË°åÂä®ÁÇπÔºå15Â≠óÂÜÖ)„ÄÇ
                ÂøÖÈ°ªËøîÂõûJSONÊ†ºÂºè: {"milestones": [{"title": "...", "tip": "..."}]}`;
                
                let milestones = [
                    { title: "ÂàùÊúüÂáÜÂ§á", tip: "Êî∂ÈõÜÂøÖË¶ÅÂ∑•ÂÖ∑ÔºåÊòéÁ°ÆÁ¨¨‰∏ÄÊ≠•Âä®‰Ωú" },
                    { title: "Ê†∏ÂøÉÊâßË°å", tip: "‰øùÊåÅ‰∏ìÊ≥®ÔºåÂÆåÊàêÊúÄÂÖ≥ÈîÆÁöÑÁéØËäÇ" },
                    { title: "Â§çÁõòÊî∂Â∞æ", tip: "Ê£ÄÊü•ÊàêÊûúÔºåÂ∫ÜÁ•ùÊØè‰∏Ä‰∏™Â∞èËøõÂ±ï" }
                ];

                try {
                    if (apiKey) {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `ÁõÆÊ†áÔºö${inputText}` }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });
                        const result = await response.json();
                        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            const aiData = JSON.parse(result.candidates[0].content.parts[0].text);
                            milestones = aiData.milestones;
                        }
                    }
                } catch (err) { console.warn("AI Êé•Âè£Ë∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÊãÜËß£ÊñπÊ°à"); }

                const newFlag = {
                    title: inputText,
                    progress: 0,
                    steps: milestones.map(m => ({ title: m.title, tip: m.tip, done: false })),
                    uid: user?.uid,
                    userName: `User_${user?.uid?.slice(0, 4) || 'Anon'}`,
                    createdAt: firebaseReady ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString()
                };

                if (firebaseReady && user) {
                    const ref = await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').add(newFlag);
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(ref.id).set(newFlag);
                } else {
                    setMyFlags(p => [...p, { id: Date.now().toString(), ...newFlag }]);
                }
                setIsCreating(false);
                setInputText('');
                setIsLoading(false);
            };

            const toggleStep = async (flagId, idx) => {
                const flag = myFlags.find(f => f.id === flagId);
                if (!flag) return;
                const newSteps = [...flag.steps];
                newSteps[idx].done = !newSteps[idx].done;
                const progress = Math.round((newSteps.filter(s => s.done).length / newSteps.length) * 100);
                
                if (!newSteps[idx].done === false) confetti({ particleCount: 40, spread: 50, origin: { y: 0.8 }, colors: ['#FF3B30'] });

                if (firebaseReady && user) {
                    const batch = db.batch();
                    batch.update(db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').doc(flagId), { steps: newSteps, progress });
                    batch.update(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(flagId), { steps: newSteps, progress });
                    await batch.commit();
                }
            };

            return (
                <div className="h-screen w-screen flex flex-col bg-[#F8F9FB] overflow-hidden">
                    {/* Header */}
                    <header className="shrink-0 glass-header px-6 pb-4 pt-[var(--safe-top)] border-b border-gray-100/80 z-20 flex justify-between items-end h-24">
                        <h1 className="text-2xl font-black tracking-tighter">{view === 'home' ? 'MY FLAGS' : 'EXPLORE'}</h1>
                        <div className="flex items-center gap-1 bg-green-50 px-2 py-1 rounded-md">
                            <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                            <span className="text-[10px] font-bold text-green-600 uppercase">AI Coach Ready</span>
                        </div>
                    </header>

                    {/* List */}
                    <main className="flex-grow overflow-y-auto no-scrollbar px-6 py-6 pb-32">
                        {view === 'home' ? (
                            <div className="space-y-6">
                                {myFlags.map(flag => (
                                    <div key={flag.id} className="bg-white rounded-[2.5rem] p-7 card-shadow border border-gray-50">
                                        <h2 className="text-xl font-bold mb-6 text-gray-800 leading-tight">{flag.title}</h2>
                                        <div className="space-y-4 mb-8">
                                            {flag.steps.map((step, i) => (
                                                <div key={i} onClick={() => toggleStep(flag.id, i)} className="flex gap-4 group cursor-pointer">
                                                    <div className={`shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${step.done ? 'bg-red-500 border-red-500' : 'border-gray-200'}`}>
                                                        {step.done && <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4"><path d="M20 6L9 17l-5-5"></path></svg>}
                                                    </div>
                                                    <div className="flex-grow">
                                                        <p className={`font-bold text-sm ${step.done ? 'text-gray-300 line-through' : 'text-gray-700'}`}>{step.title}</p>
                                                        {step.tip && !step.done && <p className="text-[11px] text-gray-400 mt-1 font-medium italic">üí° {step.tip}</p>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="flex-grow h-2 bg-gray-50 rounded-full overflow-hidden">
                                                <div className="h-full flag-gradient transition-all duration-1000" style={{width: `${flag.progress}%`}}></div>
                                            </div>
                                            <span className="text-xs font-black text-gray-300 italic">{flag.progress}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 gap-4">
                                {publicFlags.map(p => (
                                    <div key={p.id} className="bg-white p-5 rounded-3xl card-shadow flex items-center justify-between border border-gray-50">
                                        <div className="max-w-[70%]">
                                            <p className="font-bold text-gray-800 truncate">{p.title}</p>
                                            <p className="text-[10px] font-bold text-red-400/50 uppercase mt-1 tracking-widest">@{p.userName}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-lg font-black text-gray-900">{p.progress}%</p>
                                            <div className="w-10 h-1 bg-gray-100 rounded-full mt-1 overflow-hidden">
                                                <div className="h-full bg-black" style={{width: `${p.progress}%`}}></div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Nav */}
                    <nav className="shrink-0 glass-header border-t border-gray-100 px-12 pb-[calc(var(--safe-bottom)+1rem)] pt-4 flex justify-between items-center z-30">
                        <button onClick={() => setView('home')} className={view === 'home' ? 'text-red-500' : 'text-gray-300'}><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg></button>
                        <button onClick={() => setIsCreating(true)} className="w-14 h-14 -mt-12 flag-gradient rounded-[20px] shadow-xl shadow-red-200 flex items-center justify-center text-white text-3xl font-light active:scale-95 transition-all border-4 border-white">+</button>
                        <button onClick={() => setView('discover')} className={view === 'discover' ? 'text-red-500' : 'text-gray-300'}><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path></svg></button>
                    </nav>

                    {/* Create Modal */}
                    {isCreating && (
                        <div className="fixed inset-0 z-50 flex items-end">
                            <div className="absolute inset-0 bg-gray-900/20 backdrop-blur-md" onClick={() => !isLoading && setIsCreating(false)}></div>
                            <div className="relative w-full bg-white rounded-t-[3rem] p-9 pb-[calc(var(--safe-bottom)+2rem)] modal-enter shadow-2xl">
                                <div className="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-8"></div>
                                <h3 className="text-2xl font-black mb-2 tracking-tighter">Á´ã‰∏ã‰Ω†ÁöÑÊñ∞ FLAG</h3>
                                <p className="text-xs font-bold text-gray-400 mb-6 uppercase tracking-widest">AI Coach will guide your way</p>
                                <textarea 
                                    autoFocus 
                                    value={inputText} 
                                    onChange={(e) => setInputText(e.target.value)} 
                                    placeholder="ËæìÂÖ•‰Ω†ÁöÑÁõÆÊ†áÔºå‰æãÂ¶ÇÔºö‰∏Ä‰∏™ÊúàÂáèÈáç5KG" 
                                    className="w-full text-lg font-bold border-none focus:ring-0 placeholder:text-gray-200 resize-none mb-8 h-32 bg-gray-50 rounded-3xl p-6"
                                />
                                <button 
                                    onClick={handleAISplit} 
                                    disabled={isLoading || !inputText} 
                                    className="w-full py-5 rounded-2xl bg-black text-white font-black tracking-widest uppercase disabled:bg-gray-100 transition-all flex justify-center items-center gap-3"
                                >
                                    {isLoading ? <><div className="w-4 h-4 border-2 border-white/20 border-t-white rounded-full animate-spin"></div><span>ÊãÜËß£‰∏≠...</span></> : "ÁîüÊàê AI ËÆ°Âàí"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
