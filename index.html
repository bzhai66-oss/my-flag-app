<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flag - ä½ çš„ç›®æ ‡è¾¾æˆåŠ©æ‰‹</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root { --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: #F8F9FB; color: #1D1D1F; overflow: hidden; }
        .flag-gradient { background: linear-gradient(135deg, #FF3B30 0%, #FF2D55 100%); }
        .success-gradient { background: linear-gradient(135deg, #34C759 0%, #30B0C7 100%); }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); }
        .card-shadow { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03); }
        .modal-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .login-bg { background-image: radial-gradient(circle at 20% 30%, #fff0f0 0%, #f8f9fb 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- æ¨¡æ‹Ÿ Firebase åˆå§‹åŒ– ---
        let db = null;
        let auth = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'flag-final-demo-v3';

        const initFirebase = () => {
            if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                try {
                    const config = JSON.parse(__firebase_config);
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    return true;
                } catch (e) { console.error(e); }
            }
            return false;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [authLoaded, setAuthLoaded] = useState(false);
            const [demoMode, setDemoMode] = useState(false);

            useEffect(() => {
                const ready = initFirebase();
                if (ready) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        setAuthLoaded(true);
                    });
                    return () => unsubscribe();
                } else {
                    setAuthLoaded(true);
                }
            }, []);

            const handleSignOut = () => {
                if (auth) auth.signOut();
                setDemoMode(false);
                setUser(null);
            };

            if (!authLoaded) return (
                <div className="h-screen w-screen flex items-center justify-center bg-white text-red-500">
                    <div className="w-8 h-8 border-4 border-current border-t-transparent rounded-full animate-spin"></div>
                </div>
            );

            // åªæœ‰ç™»å½•æˆåŠŸæˆ–å¼€å¯ Demo æ¨¡å¼æ‰è¿›å…¥ä¸»é¡µé¢
            if (user || demoMode) {
                return <MainApp user={user || { uid: 'demo-user-id' }} onSignOut={handleSignOut} />;
            }

            return <LoginScreen onLoginSuccess={() => setDemoMode(true)} />;
        }

        // --- ç™»å½•å± (æ¨¡æ‹Ÿä½“éªŒ) ---
        function LoginScreen({ onLoginSuccess }) {
            const [isBusy, setIsBusy] = useState(false);
            
            const performMockLogin = async () => {
                setIsBusy(true);
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // å¦‚æœæœ‰ Firebase ç¯å¢ƒåˆ™å°è¯•çœŸå®åŒ¿åç™»å½•ï¼Œå¦åˆ™ç›´æ¥è¿›å…¥ Demo
                if (auth) {
                    try { await auth.signInAnonymously(); } catch (e) { console.warn("Firebase Auth failed, fallback to demo."); }
                }
                
                onLoginSuccess();
                setIsBusy(false);
            };

            return (
                <div className="h-screen w-screen login-bg flex flex-col px-8 justify-center items-center">
                    {/* æ ‡å¿—æ€§çš„å€¾æ–œå›¾æ ‡ */}
                    <div className="w-20 h-20 flag-gradient rounded-[2.2rem] shadow-2xl flex items-center justify-center text-white text-4xl font-black mb-8 italic transform -rotate-3 transition-transform hover:rotate-0 duration-500">
                        F
                    </div>
                    
                    <div className="text-center mb-12">
                        <h1 className="text-3xl font-black tracking-tighter mb-2">FLAG</h1>
                        <p className="text-slate-400 font-bold text-sm uppercase tracking-[0.2em]">ä½ çš„ç›®æ ‡è¾¾æˆåŠ©æ‰‹</p>
                    </div>

                    <button 
                        onClick={performMockLogin}
                        disabled={isBusy}
                        className="w-full max-w-sm py-4 flag-gradient text-white rounded-2xl font-black shadow-lg shadow-red-100 active:scale-95 transition-all flex justify-center items-center h-[56px]"
                    >
                        {isBusy ? (
                            <div className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                        ) : "å¿«é€Ÿä½“éªŒæ¼”ç¤ºç‰ˆ"}
                    </button>
                    
                    <p className="mt-8 text-[10px] text-slate-300 font-bold uppercase tracking-widest">Powered by Gemini AI</p>
                </div>
            );
        }

        // --- ä¸»åº”ç”¨é€»è¾‘ ---
        function MainApp({ user, onSignOut }) {
            const [view, setView] = useState('home'); // 'home' (Flags) or 'discover' (Square)
            const [isCreating, setIsCreating] = useState(false);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [myFlags, setMyFlags] = useState([]);
            const [publicFlags, setPublicFlags] = useState([]);

            // æ¨¡æ‹Ÿè¿è¥æ•°æ®æ³¨å…¥
            useEffect(() => {
                const mockMyFlags = [
                    {
                        id: 'm1',
                        title: 'å­¦ä¼šä½¿ç”¨ React Hooks',
                        progress: 100,
                        steps: [
                            { title: 'ç†è§£ useState', done: true },
                            { title: 'æŒæ¡ useEffect', done: true },
                            { title: 'å®æˆ˜è‡ªå®šä¹‰ Hook', done: true }
                        ],
                        createdAt: Date.now()
                    },
                    {
                        id: 'm2',
                        title: 'å®ŒæˆåŠç¨‹é©¬æ‹‰æ¾è®­ç»ƒ',
                        progress: 66,
                        steps: [
                            { title: '5å…¬é‡ŒåŸºç¡€è·‘', done: true },
                            { title: '10å…¬é‡Œè€åŠ›è·‘', done: true },
                            { title: '15å…¬é‡Œé…é€Ÿç»ƒ', done: false }
                        ],
                        createdAt: Date.now() - 86400000
                    },
                    {
                        id: 'm3',
                        title: 'è¯»å®Œã€ŠåŸåˆ™ã€‹',
                        progress: 33,
                        steps: [
                            { title: 'ç¬¬ä¸€éƒ¨åˆ†ï¼šæˆ‘çš„ä¸ªäººèƒŒæ™¯', done: true },
                            { title: 'ç¬¬äºŒéƒ¨åˆ†ï¼šç”Ÿæ´»åŸåˆ™', done: false },
                            { title: 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥ä½œåŸåˆ™', done: false }
                        ],
                        createdAt: Date.now() - 172800000
                    }
                ];
                setMyFlags(mockMyFlags);

                const mockPublic = [
                    { id: 'p1', title: 'æŒ‘æˆ˜30å¤©ä¸å–å¥¶èŒ¶', userName: 'å¥¶èŒ¶æ·±åº¦æ‚£è€…', progress: 85 },
                    { id: 'p2', title: 'å¤‡æˆ˜é›…æ€è€ƒè¯• 8.0', userName: 'Alex_W', progress: 45 },
                    { id: 'p3', title: 'æ‰“é€ ä¸€ä¸ªå¼€æº UI åº“', userName: 'æå®¢å¼ ', progress: 12 },
                    { id: 'p4', title: 'å­¦ä¹ æ³•å¼çƒ¹é¥ª', userName: 'å°å¨å¨˜', progress: 90 },
                    { id: 'p5', title: 'æ¯å¤© 6:00 èµ·åºŠæ‰“å¡', userName: 'æ™¨å‹äºº', progress: 100 }
                ];
                setPublicFlags(mockPublic);
            }, []);

            const handleAISplit = async () => {
                if (!inputText.trim()) return;
                setIsLoading(true);
                // æ¨¡æ‹Ÿ AI ç”Ÿæˆè¿‡ç¨‹
                await new Promise(r => setTimeout(r, 1500));
                
                const newFlag = {
                    id: Date.now().toString(),
                    title: inputText,
                    progress: 0,
                    steps: [
                        { title: "å¯åŠ¨å‡†å¤‡", done: false },
                        { title: "æ ¸å¿ƒæ‰§è¡Œ", done: false },
                        { title: "ç»“æœå¤ç›˜", done: false }
                    ],
                    createdAt: Date.now()
                };

                setMyFlags([newFlag, ...myFlags]);
                setIsCreating(false);
                setInputText('');
                setIsLoading(false);
            };

            const toggleStep = (flagId, idx) => {
                const updated = myFlags.map(f => {
                    if (f.id === flagId) {
                        const newSteps = f.steps.map((s, i) => i === idx ? { ...s, done: !s.done } : s);
                        const progress = Math.round((newSteps.filter(s => s.done).length / newSteps.length) * 100);
                        if (newSteps[idx].done) confetti({ particleCount: 30, spread: 60, origin: { y: 0.8 } });
                        return { ...f, steps: newSteps, progress };
                    }
                    return f;
                });
                setMyFlags(updated);
            };

            return (
                <div className="h-screen w-screen flex flex-col bg-[#F8F9FB] overflow-hidden">
                    {/* Header */}
                    <header className="shrink-0 glass-header px-6 pb-4 pt-[var(--safe-top)] border-b border-slate-100 z-20 flex justify-between items-end h-24">
                        <h1 className="text-2xl font-black tracking-tighter uppercase">
                            {view === 'home' ? 'Flags' : 'Square'}
                        </h1>
                        <button onClick={onSignOut} className="text-[10px] font-bold text-slate-300 uppercase tracking-widest border border-slate-100 px-3 py-1 rounded-full active:bg-slate-50 transition-colors">
                            Logout
                        </button>
                    </header>

                    {/* Content */}
                    <main className="flex-grow overflow-y-auto no-scrollbar px-6 py-6 pb-32">
                        {view === 'home' ? (
                            <div className="space-y-6">
                                {myFlags.map(flag => (
                                    <div key={flag.id} className={`bg-white rounded-[2.5rem] p-7 card-shadow border transition-all ${flag.progress === 100 ? 'border-green-100 ring-4 ring-green-50/50' : 'border-slate-50'}`}>
                                        <div className="flex justify-between items-start mb-6">
                                            <h2 className={`text-xl font-black pr-4 ${flag.progress === 100 ? 'text-green-600' : 'text-slate-800'}`}>
                                                {flag.title}
                                                {flag.progress === 100 && <span className="ml-2 text-lg">ğŸ†</span>}
                                            </h2>
                                        </div>
                                        <div className="space-y-4 mb-8">
                                            {flag.steps.map((step, i) => (
                                                <div key={i} onClick={() => toggleStep(flag.id, i)} className="flex gap-4 items-start cursor-pointer group">
                                                    <div className={`shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all mt-0.5 ${step.done ? (flag.progress === 100 ? 'bg-green-500 border-green-500 shadow-md' : 'bg-red-500 border-red-500 shadow-md') : 'border-slate-100 bg-slate-50 group-active:border-slate-300'}`}>
                                                        {step.done && <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4"><path d="M20 6L9 17l-5-5"></path></svg>}
                                                    </div>
                                                    <div className="flex-grow">
                                                        <p className={`font-bold text-sm ${step.done ? 'text-slate-300 line-through' : 'text-slate-700'}`}>{step.title}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="flex-grow h-2 bg-slate-50 rounded-full overflow-hidden">
                                                <div className={`h-full transition-all duration-700 ease-out ${flag.progress === 100 ? 'success-gradient' : 'flag-gradient'}`} style={{width: `${flag.progress}%`}}></div>
                                            </div>
                                            <span className={`text-[10px] font-black w-8 text-right ${flag.progress === 100 ? 'text-green-500' : 'text-slate-400'}`}>{flag.progress}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                <div className="mb-2">
                                    <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">æ­£åœ¨å‘ç”Ÿçš„æŒ‘æˆ˜</p>
                                </div>
                                {publicFlags.map(p => (
                                    <div key={p.id} className="bg-white p-6 rounded-[2rem] card-shadow flex items-center justify-between border border-slate-50 active:scale-[0.98] transition-transform">
                                        <div className="flex-grow pr-4">
                                            <p className="font-black text-slate-800 text-lg mb-2">{p.title}</p>
                                            <div className="flex items-center gap-2">
                                                <div className={`w-5 h-5 rounded-lg text-[8px] flex items-center justify-center text-white font-black ${p.progress === 100 ? 'success-gradient' : 'flag-gradient'}`}>
                                                    {p.userName.charAt(0)}
                                                </div>
                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{p.userName}</p>
                                            </div>
                                        </div>
                                        <div className="text-right shrink-0">
                                            <p className={`text-2xl font-black italic tracking-tighter ${p.progress === 100 ? 'text-green-500' : 'text-red-500'}`}>
                                                {p.progress}%
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="shrink-0 glass-header border-t border-slate-100 px-12 pb-[calc(var(--safe-bottom)+1rem)] pt-4 flex justify-between items-center z-30">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'home' ? 'text-red-500' : 'text-slate-300'}`}>
                            <FlagIcon size={22} />
                            <span className="text-[9px] font-black uppercase tracking-widest">Flags</span>
                        </button>
                        
                        <button onClick={() => setIsCreating(true)} className="w-14 h-14 -mt-12 flag-gradient rounded-2xl shadow-xl shadow-red-200 flex items-center justify-center text-white text-3xl font-light border-4 border-white transform rotate-45 active:scale-90 transition-all">
                            <span className="-rotate-45">+</span>
                        </button>
                        
                        <button onClick={() => setView('discover')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'discover' ? 'text-red-500' : 'text-slate-300'}`}>
                            <UsersIcon size={22} />
                            <span className="text-[9px] font-black uppercase tracking-widest">Square</span>
                        </button>
                    </nav>

                    {/* Create Modal */}
                    {isCreating && (
                        <div className="fixed inset-0 z-50 flex items-end">
                            <div className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onClick={() => !isLoading && setIsCreating(false)}></div>
                            <div className="relative w-full bg-white rounded-t-[3rem] p-9 pb-[calc(var(--safe-bottom)+2rem)] modal-enter shadow-2xl">
                                <div className="w-12 h-1.5 bg-slate-100 rounded-full mx-auto mb-8"></div>
                                <h3 className="text-2xl font-black mb-1 tracking-tight">æ–°çš„æŒ‘æˆ˜</h3>
                                <p className="text-slate-400 text-xs mb-6 font-bold uppercase tracking-widest">è¾“å…¥ä½ çš„ç›®æ ‡ï¼Œç”± AI æ‹†è§£è·¯å¾„</p>
                                <textarea 
                                    autoFocus 
                                    value={inputText} 
                                    onChange={(e) => setInputText(e.target.value)} 
                                    placeholder="ä¾‹å¦‚ï¼šä¸‰ä¸ªæœˆåå»å¤§ç†æ—…å±…" 
                                    className="w-full text-lg font-bold border-none focus:ring-0 placeholder:text-slate-200 resize-none mb-8 h-32 bg-slate-50 rounded-3xl p-6"
                                />
                                <button 
                                    onClick={handleAISplit} 
                                    disabled={isLoading || !inputText} 
                                    className="w-full py-5 rounded-2xl bg-black text-white font-black uppercase disabled:bg-slate-100 transition-all flex justify-center items-center gap-3 h-[64px]"
                                >
                                    {isLoading ? (
                                        <div className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                                    ) : "å¼€å¯è§„åˆ’"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- å›¾æ ‡ç»„ä»¶ ---
        const FlagIcon = ({size}) => <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>;
        const UsersIcon = ({size}) => <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
