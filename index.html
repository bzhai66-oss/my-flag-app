<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flag - ä½ çš„ç›®æ ‡è¾¾æˆåŠ©æ‰‹</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ç‰¹æ•ˆä¸æ•°æ®åº“ SDK -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        :root { 
            --safe-top: env(safe-area-inset-top, 20px); 
            --safe-bottom: env(safe-area-inset-bottom, 20px); 
        }

        body { 
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent; 
            background-color: #FBFBFD; 
            margin: 0;
            color: #1D1D1F;
        }

        .flag-gradient { background: linear-gradient(135deg, #FF3B30 0%, #FF2D55 100%); }
        .glass-header { 
            background: rgba(251, 251, 253, 0.8); 
            backdrop-filter: saturate(180%) blur(20px); 
            -webkit-backdrop-filter: saturate(180%) blur(20px); 
        }
        
        .card-shadow { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04); }
        .safe-pb { padding-bottom: calc(var(--safe-bottom) + 6rem); }
        .safe-pt { padding-top: calc(var(--safe-top) + 4.5rem); }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-item { animation: slideUp 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. Firebase åˆå§‹åŒ– (éµå®ˆä¸‰ä¸ªå¼ºåˆ¶è§„åˆ™) ---
        let db = null;
        let auth = null;
        let firebaseReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'flag-pro-v1';

        try {
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseReady = true;
            }
        } catch (e) { console.warn("Firebase not available"); }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); // 'home' | 'discover'
            const [isCreating, setIsCreating] = useState(false);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [myFlags, setMyFlags] = useState([]);
            const [publicFlags, setPublicFlags] = useState([]);

            // è§„åˆ™ 3: ä¼˜å…ˆå¤„ç† Auth
            useEffect(() => {
                const initAuth = async () => {
                    if (!firebaseReady) {
                        setUser({ uid: 'local_user', displayName: 'æ¸¸å®¢' });
                        return;
                    }
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) { console.error("Auth Error", err); }
                };
                initAuth();
                const unsub = auth.onAuthStateChanged(setUser);
                return () => unsub();
            }, []);

            // è§„åˆ™ 1 & 2: ä¸¥æ ¼è·¯å¾„ç›‘å¬ä¸ç®€å•æŸ¥è¯¢
            useEffect(() => {
                if (!user || !firebaseReady) return;

                // ç›‘å¬ä¸ªäºº Flags
                const myUnsub = db.collection('artifacts').doc(appId)
                    .collection('users').doc(user.uid).collection('flags')
                    .onSnapshot(snap => {
                        setMyFlags(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, err => console.error("My Flags Sync Error", err));

                // ç›‘å¬å…¬å…±å¹¿åœº
                const pubUnsub = db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('sharedFlags')
                    .onSnapshot(snap => {
                        setPublicFlags(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, err => console.error("Public Flags Sync Error", err));

                return () => { myUnsub(); pubUnsub(); };
            }, [user]);

            // AI æ‹†è§£é€»è¾‘
            const handleAISplit = async () => {
                if (!inputText.trim()) return;
                setIsLoading(true);
                
                const apiKey = ""; 
                const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªç›®æ ‡æ•™ç»ƒã€‚è¯·å°†ç›®æ ‡æ‹†è§£ä¸º3ä¸ªæ ¸å¿ƒæ­¥éª¤ã€‚åªè¿”å›JSON: {\"milestones\": [{\"title\": \"...\"}]}";
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `ç›®æ ‡ï¼š${inputText}` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const result = await response.json();
                    const aiData = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    const newFlag = {
                        title: inputText,
                        progress: 0,
                        steps: aiData.milestones.map(m => ({ title: m.title, done: false })),
                        uid: user.uid,
                        userName: `ç”¨æˆ·_${user.uid.slice(0, 4)}`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (firebaseReady) {
                        // åŒæ—¶å†™å…¥ä¸ªäººåº“å’Œå…¬å…±åº“
                        const ref = await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').add(newFlag);
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(ref.id).set(newFlag);
                    }
                    
                    setIsCreating(false);
                    setInputText('');
                } catch (err) {
                    console.error("Split error", err);
                    setIsCreating(false);
                } finally { setIsLoading(false); }
            };

            // --- å…³é”®ä¼˜åŒ–: åŒæ—¶æ›´æ–°æœ¬åœ°ä¸å¹¿åœºçš„è¿›åº¦ ---
            const toggleStep = async (flagId, idx) => {
                const flag = myFlags.find(f => f.id === flagId);
                if (!flag) return;

                const newSteps = [...flag.steps];
                const wasDone = newSteps[idx].done;
                newSteps[idx].done = !wasDone;
                
                if (!wasDone) {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.8 },
                        colors: ['#FF3B30', '#FF2D55', '#FFCC00']
                    });
                }

                const progress = Math.round((newSteps.filter(s => s.done).length / newSteps.length) * 100);
                
                if (firebaseReady) {
                    const batch = db.batch();
                    
                    // 1. æ›´æ–°ä¸ªäººæ–‡æ¡£
                    const myRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').doc(flagId);
                    batch.update(myRef, { steps: newSteps, progress });
                    
                    // 2. åŒæ­¥æ›´æ–°å¹¿åœºæ–‡æ¡£ (ä¿®å¤ç‚¹)
                    const pubRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(flagId);
                    batch.update(pubRef, { steps: newSteps, progress });
                    
                    await batch.commit();
                }
            };

            const deleteFlag = async (id) => {
                if (!window.confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) return;
                if (firebaseReady) {
                    const batch = db.batch();
                    batch.delete(db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('flags').doc(id));
                    batch.delete(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sharedFlags').doc(id));
                    await batch.commit();
                }
            };

            return (
                <div className="min-h-screen flex flex-col bg-[#FBFBFD]">
                    <header className="fixed top-0 inset-x-0 glass-header z-30 px-6 pb-4 pt-[var(--safe-top)] border-b border-gray-100/50">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">ğŸ¯</span>
                                <h1 className="text-xl font-extrabold tracking-tight">
                                    {view === 'home' ? 'æˆ‘çš„ Flag' : 'å‘ç°å¹¿åœº'}
                                </h1>
                            </div>
                            <div className="px-3 py-1 bg-green-50 rounded-full">
                                <span className="text-[10px] font-bold text-green-600 uppercase tracking-widest">Live Sync</span>
                            </div>
                        </div>
                    </header>

                    <main className="px-5 safe-pt safe-pb flex-grow overflow-y-auto no-scrollbar">
                        {view === 'home' ? (
                            <div className="space-y-6">
                                {myFlags.length === 0 && !isLoading && (
                                    <div className="py-32 flex flex-col items-center justify-center opacity-30">
                                        <div className="text-7xl mb-6">ğŸœï¸</div>
                                        <p className="font-bold">ç«‹ä¸ª Flagï¼Œå»å¾æœå®ƒ</p>
                                    </div>
                                )}
                                {myFlags.map((flag, index) => (
                                    <div key={flag.id} className="bg-white rounded-[2.5rem] p-7 card-shadow animate-item" style={{animationDelay: `${index * 0.1}s`}}>
                                        <div className="flex justify-between items-start mb-6">
                                            <h2 className="text-2xl font-black text-gray-900 leading-tight pr-4">{flag.title}</h2>
                                            <button onClick={() => deleteFlag(flag.id)} className="p-2 opacity-10"><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                        </div>
                                        <div className="space-y-3 mb-8">
                                            {flag.steps.map((step, i) => (
                                                <div key={i} onClick={() => toggleStep(flag.id, i)} className={`flex items-center gap-4 p-4 rounded-2xl transition-all active:scale-[0.98] ${step.done ? 'bg-gray-50' : 'bg-gray-50/50 border border-gray-100'}`}>
                                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 transition-all ${step.done ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>
                                                        {step.done && <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4"><path d="M20 6L9 17l-5-5"></path></svg>}
                                                    </div>
                                                    <span className={`text-sm font-bold ${step.done ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{step.title}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                            <div className="h-full flag-gradient transition-all duration-1000" style={{width: `${flag.progress}%`}}></div>
                                        </div>
                                        <div className="mt-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">Progress {flag.progress}%</div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-4 animate-item">
                                {publicFlags.length === 0 && <p className="text-center py-20 text-gray-400">å¹¿åœºæš‚æ—¶ç©ºæ— ä¸€äºº...</p>}
                                {publicFlags.map(p => (
                                    <div key={p.id} className="bg-white p-6 rounded-3xl card-shadow border border-gray-50 flex items-center justify-between transition-all">
                                        <div>
                                            <p className="font-extrabold text-gray-800 text-lg">{p.title}</p>
                                            <p className="text-[10px] text-gray-400 font-bold uppercase mt-1">By {p.userName}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-pink-500">{p.progress}%</div>
                                            <div className="text-[8px] text-gray-300 font-black uppercase tracking-tighter">Completion</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 inset-x-0 glass-header border-t border-gray-100/50 flex justify-around items-center px-10 pb-[calc(var(--safe-bottom)+0.5rem)] pt-3 z-40">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 transition-all ${view === 'home' ? 'text-red-500' : 'text-gray-300'}`}>
                            <span className="text-xl">ğŸ </span>
                            <span className="text-[10px] font-black uppercase">Home</span>
                        </button>
                        <div className="relative -mt-12">
                            <button onClick={() => setIsCreating(true)} className="w-16 h-16 flag-gradient rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-white text-4xl font-light active:scale-90 transition-all border-4 border-white">+</button>
                        </div>
                        <button onClick={() => setView('discover')} className={`flex flex-col items-center gap-1 transition-all ${view === 'discover' ? 'text-red-500' : 'text-gray-300'}`}>
                            <span className="text-xl">ğŸŒ</span>
                            <span className="text-[10px] font-black uppercase">Global</span>
                        </button>
                    </nav>

                    {isCreating && (
                        <div className="fixed inset-0 z-50 flex items-end">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-md" onClick={() => !isLoading && setIsCreating(false)}></div>
                            <div className="relative w-full bg-white rounded-t-[3rem] p-10 pb-[calc(var(--safe-bottom)+2rem)] animate-slide-up">
                                <div className="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-8"></div>
                                <h3 className="text-3xl font-black mb-6 tracking-tighter">ä¸‹ä¸€ä¸ªæŒ‘æˆ˜æ˜¯ï¼Ÿ</h3>
                                <textarea autoFocus value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="è¾“å…¥ç›®æ ‡..." className="w-full text-2xl font-bold border-none focus:ring-0 placeholder:text-gray-200 resize-none mb-8" rows="3"/>
                                <button onClick={handleAISplit} disabled={isLoading || !inputText} className="w-full py-5 rounded-3xl bg-black text-white font-black tracking-widest uppercase disabled:bg-gray-100 flex items-center justify-center gap-3 transition-all">
                                    {isLoading ? <div className="w-5 h-5 border-4 border-white/30 border-t-white rounded-full animate-spin"></div> : "å¼€å§‹æ‹†è§£"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
